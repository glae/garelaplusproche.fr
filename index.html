<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8">
  <title>Gare la plus proche</title>
  <meta name="keywords" content="gare, la, plus, proche" />
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <script src="cities.js"></script>
  <script src="main.js"></script>
  <link rel="icon" type="image/png" href="./img/tchou.png" />
  <link rel="stylesheet" type="text/css" href="index.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin="" />

  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>
  <script>
    var map;

    function searchFromGeolocation() {
        document.getElementById("search-btn-container").className += 'active-button';
        document.getElementById("train").className += 'loader';
        document.getElementById("stations").className += "station-element";
        var warning = document.createElement("p");
        warning.innerText= 'Si rien ne se passe, c\'est peut-être que vous n\'avez pas accepté la géolocalisation.';
        setTimeout(function(){
            document.getElementById("trainLoader-buttonSearch-container").appendChild(warning);
        }, 6000);

        var geoSuccess = function(p) {
            const mapContainerElement = document.getElementById('mapcontainer');
            mapContainerElement.innerHTML = "<div id='mapid'></div>";
            mapContainerElement.className += "map-container-element";

            const foundStations = findNearestStations(stations, p.coords.latitude, p.coords.longitude);

            displayResults(p.coords.latitude, p.coords.longitude, foundStations);
        };

        navigator.geolocation.getCurrentPosition(geoSuccess);
    };
    
    function searchFromCityCoordinates() {
        var search = document.getElementById('search-by-city-field').value;
        var matchedCities = cities.filter(function(city){
            return Object.keys(city)[0] === search;
        });
        
        if(matchedCities.length  === 1)
        {
            document.getElementById('search-by-city-container').style.display = 'none';
            
            const mapContainerElement = document.getElementById('mapcontainer');
            mapContainerElement.innerHTML = "<div id='mapid'></div>";
            mapContainerElement.className += "map-container-element";
            
            var searchedCity = matchedCities[0];
            
            var latitude = Object.keys(searchedCity).map(k => searchedCity[k])[0][0];
            var longitude = Object.keys(searchedCity).map(k => searchedCity[k])[0][1];
            
            const foundStations = findNearestStations(stations, parseFloat(latitude), parseFloat(longitude));

            displayResults(latitude, longitude, foundStations);
        }
    }
    
    function displayResults(userLat, userLong, foundStations)
    {
        map = L.map('mapid').setView([userLat, userLong], 11);

        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png').addTo(map);

        var trainIcon = new L.Icon({
          iconUrl:'./img/tchou.png',
          iconSize: [40, 40]
        });

        var homeIcon = new L.Icon({
          iconUrl: './img/gps2.png',
          iconSize: [40, 51]
        });

        foundStations.forEach(function(e) {
          L.marker([latitude(e), longitude(e)], {
            icon: trainIcon
          }).addTo(map).bindPopup("<p style='font-size:150%'>" + stationName(e) +
            "<br><a href='https://www.trainline.fr/search/" + encodeURI(stationName(e).replace(/'/g, "%27")) + "/' target='_blank' style='color: #D35400; font-weight: 700; text-decoration: none;'>Partir avec trainline</a></p>");
        });

        L.marker([userLat, userLong], {
          icon: homeIcon
        }).addTo(map).bindPopup('<p style="font-size:150%">Votre position</p>');

        document.getElementById('stations').innerHTML = '' +
          '<h2>Voici les gares trouvées :</h2>' +
          '<ul>' +
          foundStations.map(gare => '<li>' + stationName(gare) + '</li>').join('') +
          '</ul>';
    }
    
    document.addEventListener("DOMContentLoaded", function(event)
    {
        cities.forEach(function(city) {
            var cityOption = document.createElement("option");
            cityOption.innerHTML = Object.keys(city)[0];
            cityOption.dataset.long = Object.keys(city).map(k => city[k])[0][1];
            cityOption.dataset.lat = Object.keys(city).map(k => city[k])[0][0];
            document.getElementById("cities").appendChild(cityOption);
        });
    });

  </script>
</head>

<body>
  <header>
    <h1>Trouvez la <span>gare</span><br/>la plus <span>proche</span></h1>
  </header>
  <section class="station-search-container">
    <br>
    <div id="stations"></div>
    <div id="mapcontainer">
      <div id="mapid"></div>
    </div>
    <div id="trainLoader-buttonSearch-container">
      <div id="search-btn-container" onclick="searchFromGeolocation()" style="border-radius:50%">
        <button id="search-btn"><img src="./img/iconLocalisation.svg"  alt=""></button>
      </div>
        <span id="train"></span>
    </div>
    
    <div id="search-by-city-container">
        <input list="cities" type="text" id="search-by-city-field">
        <datalist id="cities"></datalist>
        <button id="search-by-city-btn" onclick="searchFromCityCoordinates()">Chercher par ville</button>
    </div>
  </section>

  <footer>
    <span>
      - Ce site n'est ni affilié à la SNCF ni à trainline -
    </span>
    <a href="https://github.com/glae/lagarelaplusproche.fr">
      Sources sur github
    </a>
  </footer>
</body>

</html>
